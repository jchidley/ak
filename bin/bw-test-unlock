#!/bin/bash
# Auto-unlock test Bitwarden vault
# Password fetched from main vault

# Check main vault is unlocked
if [[ -z "$BW_SESSION" ]]; then
  echo "❌ Main vault locked. Run: bw_unlock"
  exit 1
fi

echo "Fetching test account password from main vault..."
TEST_PASSWORD=$(bw get password "Bitwarden Test Account" --session "$BW_SESSION" 2>/dev/null)

if [[ -z "$TEST_PASSWORD" ]]; then
  echo "❌ Test password not found in main vault"
  echo ""
  echo "Create item in main vault:"
  echo "  Name: Bitwarden Test Account"
  echo "  Username: jackc@chidley.org"
  echo "  Password: nXz4j#VqCH@k"
  echo "  URI: https://vault.bitwarden.eu"
  exit 1
fi

echo "Configuring test server..."
bw config server https://vault.bitwarden.eu >/dev/null

echo "Checking login status..."
STATUS=$(bw status 2>/dev/null | jq -r '.status' 2>/dev/null)

if [[ "$STATUS" == "unauthenticated" ]]; then
  echo "Logging in..."
  export BW_PASSWORD="$TEST_PASSWORD"
  bw login jackc@chidley.org --passwordenv BW_PASSWORD >/dev/null
fi

echo "Unlocking test vault..."
export BW_TEST_SESSION=$(printf "%s" "$TEST_PASSWORD" | bw unlock --raw --passwordenv BW_PASSWORD 2>/dev/null)

if [[ -z "$BW_TEST_SESSION" ]]; then
  echo "❌ Failed to unlock test vault"
  exit 1
fi

# Verify
if bw status --session "$BW_TEST_SESSION" 2>/dev/null | grep -q '"status":"unlocked"'; then
  echo "✓ Test vault unlocked"
  echo ""
  echo "To use in current shell:"
  echo "  export BW_TEST_SESSION=\"$BW_TEST_SESSION\""
  echo ""
  echo "Then run: load-test-keys"
else
  echo "❌ Failed to verify unlock"
  exit 1
fi
